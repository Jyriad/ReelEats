<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light only">
    <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://unpkg.com https://www.tiktok.com https://*.ttwstatic.com https://*.tiktok.com https://*.byteoversea.com;
    style-src 'self' 'unsafe-inline' https://unpkg.com https://*.ttwstatic.com https://*.tiktok.com;
    font-src 'self' data: https://unpkg.com https://*.tiktok.com;
    img-src 'self' data: https://*.basemaps.cartocdn.com https://unpkg.com https://*.tiktok.com https://*.ttwstatic.com https://images.unsplash.com;
    frame-src 'self' https://www.tiktok.com https://*.tiktok.com;
    connect-src 'self' https://*.basemaps.cartocdn.com https://jsuxrpnfofkigdfpnuua.supabase.co https://*.tiktok.com https://*.byteoversea.com https://*.tiktokv.com https://unpkg.com https://*.ttwstatic.com;
    media-src 'self' https://*.tiktok.com;
">
    <title id="index-title">ReelGrub - Discover Your Next Spot</title>
    
    <!-- Load version number immediately -->
    <script type="module">
        async function loadVersionNumber() {
            try {
                const { versionNumber } = await import('./config.js');
                // Update title
                const titleElement = document.getElementById('index-title');
                if (titleElement) {
                    titleElement.textContent = `ReelGrub v${versionNumber} - Discover Your Next Spot`;
                }
            } catch (error) {
                console.log('Could not load version number:', error);
                // Keep fallback title
            }
        }
        loadVersionNumber();
    </script>

    <link rel="stylesheet" href="styles.css">
</head>
<body class="homepage">
  <header class="header">
    <div class="logo">ReelGrub</div>
    <nav>
      <a href="/explore" class="nav-link">Explore</a>
      <a href="/explore#auth" class="nav-link">Log In</a>
      <a href="/explore#auth" class="nav-button">Sign Up</a>
    </nav>
  </header>

  <main>
    <section class="hero">
      <h1>Discover your next favorite restaurant, one reel at a time.</h1>
      <div class="search-container">
        <input type="text" placeholder="Enter a city..." class="search-bar" id="city-search">
        <button class="search-button" id="search-button">Search</button>
        <div class="autocomplete-dropdown" id="autocomplete-dropdown" style="display: none;"></div>
      </div>
    </section>

    <section class="featured-cities">
      <h2>Featured Cities</h2>
      <div class="city-grid">
        <a href="/london" class="city-card">
          <img src="https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?q=80&w=2070" alt="London">
          <span>London</span>
        </a>
        <a href="/manchester" class="city-card">
          <img src="https://images.unsplash.com/photo-1598380231975-1911a3c1c4d2?q=80&w=2070" alt="Manchester">
          <span>Manchester</span>
        </a>
        <a href="/birmingham" class="city-card">
          <img src="https://images.unsplash.com/photo-1596542095819-03f3933f93f1?q=80&w=2070" alt="Birmingham">
          <span>Birmingham</span>
        </a>
      </div>
    </section>
  </main>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script async src="https://www.tiktok.com/embed.js"></script>
    
    <script>
        // Homepage search functionality
        document.addEventListener('DOMContentLoaded', async function() {
            const searchInput = document.getElementById('city-search');
            const searchButton = document.getElementById('search-button');
            const autocompleteDropdown = document.getElementById('autocomplete-dropdown');
            
            let cities = [];
            let filteredCities = [];
            
            // Initialize Supabase
            const { createClient } = supabase;
            const supabaseUrl = 'https://jsuxrpnfofkigdfpnuua.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpzdXhycG5mb2ZraWdkZnBudXVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNzU3NTMsImV4cCI6MjA2OTk1MTc1M30.EgMu5bfHNPcVGpQIL8pL_mEFTouQG1nXOnP0mee0WJ8';
            const supabaseClient = createClient(supabaseUrl, supabaseKey);
            
            // Load cities from cache or database
            async function loadCities() {
                const CACHE_KEY = 'reelEats_citiesCache';
                const CACHE_DURATION = 1000 * 60 * 60 * 24; // 24 hours
                
                // Try to load from cache first
                const cachedData = localStorage.getItem(CACHE_KEY);
                if (cachedData) {
                    const { cities: cachedCities, timestamp } = JSON.parse(cachedData);
                    if (Date.now() - timestamp < CACHE_DURATION) {
                        cities = cachedCities;
                        return;
                    }
                }
                
                // Fetch from database
                try {
                    const { data: citiesData, error } = await supabaseClient.from('cities').select('id, name, lat, lon');
                    if (error) {
                        console.error('Error fetching cities:', error);
                        return;
                    }
                    cities = citiesData;
                    localStorage.setItem(CACHE_KEY, JSON.stringify({ cities: citiesData, timestamp: Date.now() }));
                } catch (error) {
                    console.error('Error loading cities:', error);
                }
            }
            
            // Filter cities based on search input
            function filterCities(query) {
                if (!query || query.length < 2) {
                    return [];
                }
                return cities.filter(city => 
                    city.name.toLowerCase().startsWith(query.toLowerCase())
                ).slice(0, 5); // Limit to 5 results
            }
            
            // Display autocomplete dropdown
            function showAutocomplete(results) {
                if (results.length === 0) {
                    autocompleteDropdown.style.display = 'none';
                    return;
                }
                
                autocompleteDropdown.innerHTML = '';
                results.forEach(city => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = city.name;
                    item.addEventListener('click', () => {
                        searchInput.value = city.name;
                        autocompleteDropdown.style.display = 'none';
                        navigateToCity(city.name);
                    });
                    autocompleteDropdown.appendChild(item);
                });
                autocompleteDropdown.style.display = 'block';
            }
            
            // Navigate to city page
            function navigateToCity(cityName) {
                const citySlug = cityName.toLowerCase().replace(/\s+/g, '-');
                window.location.href = `/${citySlug}`;
            }
            
            // Search input event listener
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                filteredCities = filterCities(query);
                showAutocomplete(filteredCities);
            });
            
            // Search button event listener
            searchButton.addEventListener('click', function() {
                const query = searchInput.value.trim();
                if (query) {
                    // Find exact match first
                    const exactMatch = cities.find(city => 
                        city.name.toLowerCase() === query.toLowerCase()
                    );
                    if (exactMatch) {
                        navigateToCity(exactMatch.name);
                    } else {
                        // Navigate to explore page with search query
                        window.location.href = `/explore?search=${encodeURIComponent(query)}`;
                    }
                }
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
                    autocompleteDropdown.style.display = 'none';
                }
            });
            
            // Load cities on page load
            await loadCities();
        });
    </script>
</body>
</html>